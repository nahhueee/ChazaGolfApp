<p-confirmdialog key="cerrarDialog"/>

<div class="contenido">
    <form [formGroup]="filtros" autocomplete="off" class="filtros">
        <div class="izq">
            <!-- Proceso -->
            <p-floatlabel variant="on">
                <p-select [options]="procesos" formControlName="proceso" optionLabel="descripcion"/>
                <label>Proceso</label>
            </p-floatlabel>

            <!-- Nro Proceso -->
            <p-floatlabel variant="on">
                <input pInputText formControlName="nroProceso"  type="text"/>
                <label>NÂ° Proceso</label>
            </p-floatlabel>

            <!-- Fecha -->
            <p-floatlabel variant="on">
                <p-datepicker formControlName="fechas" selectionMode="range"/>
                <label>Rango de Fecha</label>
            </p-floatlabel>

            <!-- Cliente -->
            <p-floatlabel variant="on">
                <p-autocomplete
                    formControlName="cliente"
                    [suggestions]="clientesFiltrados"
                    placeholder="Buscar por nombre o DNI"
                    emptyMessage="No se encontraron resultados"
                    (completeMethod)="FiltrarClientes($event)"
                    optionLabel="nombre"
                >
                    <!-- Template para las sugerencias -->
                    <ng-template let-cliente pTemplate="item">
                        {{ cliente.nombre }} - {{ cliente.documento }}
                    </ng-template>

                </p-autocomplete>
                <label>Cliente</label>
            </p-floatlabel>
        </div>
        <div class="der">
            <p-button label="Buscar" severity="primary" icon="pi pi-search" (onClick)="Buscar()"/>
            <p-button label="Limpiar" severity="secondary" icon="pi pi-filter-slash" (onClick)="LimpiarFiltros()" />
        </div>

        
    </form>

    <div class="tabla">
        <p-table 
        [value]="ventas"
        [lazy]="true"
        [paginator]="true"
        [rows]="10"
        [totalRecords]="totalRecords"
        (onLazyLoad)="Buscar($event)"
        [loading]="loading"
        [rowsPerPageOptions]="[10,20,50]"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords}"
        [tableStyle]="{ 'min-width': '60rem' }">
        
            <ng-template #header>
                <tr>
                    <th>Editar</th>
                    <th>Proceso</th>
                    <th>Nro</th>
                    <th>Fecha</th>
                    <th>Hora</th>
                    <th>Cliente</th>
                    <th>Total</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </ng-template>
            <ng-template #body let-venta>
                <tr>
                    <td>
                        <p-button severity="warn" styleClass="p-button-sm" [rounded]="true" [outlined]="true" icon="pi pi-pencil" (onClick)="Editar(venta.id)" pTooltip="Editar" tooltipPosition="bottom"/>
                    </td>
                    <td>{{ venta.proceso }}</td>
                    <td>{{ venta.nroProceso }}</td>
                    <td>{{ venta.fecha | date:'dd-MM-yyyy' }}</td>
                    <td>{{ venta.hora }}</td>
                    <td>{{ venta.cliente.nombre }}</td>
                    <td>${{ venta.total | decimalFormat }}</td>
                    <td>
                        <p-tag [value]="venta.estado" [severity]="GetSeverity(venta.estado)" />
                    </td>
                    <td>
                        <div class="acciones">
                            <p-button severity="primary" styleClass="p-button-sm" [rounded]="true" [outlined]="true" icon="pi pi-eye" (onClick)="ventaSeleccionada = venta; detalleVisible = true" pTooltip="Ver Resumen" tooltipPosition="bottom"/>
                            @if(tipo == "factura"){
                                <p-button severity="primary" styleClass="p-button-sm" [rounded]="true" [outlined]="true" icon="pi pi-print" (onClick)="ElegirComprobante(venta)" pTooltip="Comprobante" tooltipPosition="bottom"/>
                            }@else {
                                @if(venta.idProceso == 7 && venta.estado == "Pendiente"){
                                    <p-button severity="primary" styleClass="p-button-sm" [rounded]="true" [outlined]="true" icon="pi pi-check" (onClick)="Aprobar(venta)" pTooltip="Aprobar" tooltipPosition="bottom"/>
                                }
                            }
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>

<app-vista-previa  [(visible)]="detalleVisible" [venta]="ventaSeleccionada"></app-vista-previa>

<p-popover #op>
    <div class="opciones-impresion">
        <p-button
        label="Ver Remito"
        severity="secondary"
        styleClass="p-button-sm w-full"
        (click)="VerComprobante(); op.hide()">
        </p-button>

        <p-button
         [label]="ventaSeleccionada.proceso === 'COTIZACION' 
            ? 'Ver Comprobante' 
            : 'Ver Factura'"
        severity="success"
        styleClass="p-button-sm w-full"
        [disabled]="
        ventaSeleccionada.proceso !== 'COTIZACION' &&
        ventaSeleccionada.factura?.cae == null
        "
        (click)="VerFactura(); op.hide()">
        </p-button>
  </div>
</p-popover>
